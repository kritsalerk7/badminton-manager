<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">

  <title>Badminton Manage</title>

  <link rel="stylesheet" href="assets/css/ui-profile-modal.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    <link rel="stylesheet" href="assets/css/styles.css" />
<link rel="stylesheet" href="assets/css/ui-enhance.v4.css">
<link rel="stylesheet" href="assets/css/ui-align.columns.final.css">
<link rel="stylesheet" href="assets/css/ui-profilex.css">
<link rel="stylesheet" href="assets/css/ui-rows.compact.v2.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<style>
  .has-play .flatpickr-day{ position: relative; }
  .flatpickr-day.has-play::after{
    content:"";
    position:absolute;
    left:50%;
    bottom:6px;
    width:6px;height:6px;
    margin-left:-3px;
    border-radius:50%;
    background:#ff6600;
  }


  .lv-1{ background:#6c757d; }
  .lv-2{ background:#20c997; }
  .lv-3{ background:#17a2b8; }
  .lv-4{ background:#fd7e14; }
  .lv-5{ background:#dc3545; }
</style>
</head>
<body class="bg-light">
  <!-- Top Navigation -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary" >
    <div class="container-fluid">
      <a class="navbar-brand fw-semibold" href="#">Badminton Manage</a> <div class="ms-3" style="min-width:220px;display:inline-block;"><div id="ownerGroupSwitcher"></div></div>
	<span class="navbar-text small" style="color:#000;position:fixed;right:10px;bottom:1px;">Member version 1.3</span>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#topNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="topNav">
        <ul class="navbar-nav me-auto mb-2 mb-lg-0">
          <li class="nav-item"><a class="nav-link active" href="index.html"><i class="bi bi-people-fill me-1"></i> จัดการสมาชิก</a></li>
          <li class="nav-item"><a class="nav-link " href="court.html" id="navCourt"><i class="bi bi-columns-gap me-1"></i> จัดการคอร์ท</a></li>
          <li class="nav-item"><a class="nav-link" href="expense.html" id="navExpense"><i class="bi bi-cash-stack me-1"></i> จัดการค่าใช้จ่าย</a></li>
          <li class="nav-item"><a class="nav-link" href="stat.html" id="navStats"><i class="bi bi-graph-up-arrow me-1"></i> สถิติ</a></li>
        </ul>
		<span class="navbar-text small"><button id="btnLogout" style="position:fixed;right:12px;top:5px;z-index:9999" class="btn btn-sm btn-outline-dark">Logout</button></span>
        

      </div>
    </div>
  
<!--<div class="bg-body-tertiary border-top">
  <div class="container py-2">
    <a class="btn btn-sm btn-outline-primary" href="groups.html"><i class="bi bi-people"></i> จัดการก๊วน</a>
  </div>
</div>-->
</nav>

  <main class="container-fluid py-3 ">
    <div class="row g-3">
      <!-- Left: All Members -->
			<div class="dropzone ">
              <div class="small text-muted"><i class="bi bi-info-circle"></i> ลากชื่อ เพื่อเลือกผู้เล่นวันนี้ หรือ ยกเลิก</div>
            </div>
      <div class="col-md-4 col-sm-12">
        <div class="card shadow-sm h-100">
			
          <div class="card-header d-flex align-items-center justify-content-between">

            <div class="d-flex align-items-center gap-2">
              <i class="bi bi-people-fill "></i>
              <h5 class="card-title p-1">สมาชิกทั้งหมด</h5>
            </div>
            <div class="d-flex gap-2">
              <button id="btnAddMember" class="btn btn-sm btn-primary" title="เพิ่มสมาชิก" data-bs-toggle="modal" data-bs-target="#memberEditModal">
                <i class="bi bi-person-plus"></i>
              </button>
            </div>
          </div>
          <div class="card-body">
            <div class="row g-2 mb-2">
              <div class="col-8">
                <input id="memberSearch" class="form-control form-control-sm" placeholder="ค้นหาชื่อ" />
              </div>
              <div class="col-4">
                <select id="memberLevelFilter" class="form-select form-select-sm">
                  <option value="0">ระดับทั้งหมด</option>
                  <option value="1">มือใหม่</option>
                  <option value="2">เบา</option>
                  <option value="3">กลาง</option>
                  <option value="4">หนัก</option>
				  <option value="5">โปร</option>
                </select>
              </div>
            </div>

  

            <ul id="memberAll" class="list-group list-group-flush min-h-320" aria-label="สมาชิกทั้งหมด"></ul>
			
			
			
			<div class="d-flex justify-content-between align-items-center mt-2">
  <span id="leftCount" class="text-muted small"></span>
  <ul id="pagination" class="pagination pagination-sm m-0"></ul>
</div>
            <!-- Alpha bar -->
            <!--<div id="alphaBar">
              <div class="alpha-all">
                <button class="alpha-btn active" data-alpha="">ทั้งหมด</button>
              </div>
              <div class="alpha-grid"></div>
            </div>-->

           
          </div>
        </div>
      </div>

      <!-- Right: Today's Players -->
      <div class="col-md-8 col-sm-12 " >
      

        <div class="card shadow-sm h-100" >
          <div class="card-header d-flex align-items-center justify-content-between">
            <div class="d-flex align-items-center gap-2">
              <i class="bi bi-calendar-check"></i>
              <h5 class="card-title">ผู้ลงชื่อเล่นวันที่ <span id="dayDateText"></span></h5>
            </div>

			  <!-- Date selector -->
        <div class="d-flex align-items-center justify-content-end mb-2 " >
          <div class="input-group input-group-sm" style="max-width: 220px;">
            <span class="input-group-text"><i class="bi bi-calendar3"></i></span>
            <input type="date" id="pickDate" class="form-control" value="">
          </div>
        </div>
            <div class="d-flex gap-2">
              <button id="btnClearToday" class="btn btn-sm btn-outline-danger" title="ล้างรายชื่อวันนี้">
                <i class="bi bi-x-circle"></i>
              </button>
            </div>
          </div>
          <div class="card-body"  style = "max-height:700px;overflow: auto;">
            <!-- Mini Calendar Marks (Firestore) -->
				<small id="rightCount" class="text-muted fw-bold fs-6"></small>
            <div id="miniCalendar" class="mini-cal mb-2"></div>
		
            <ul id="todayList" class="row row-cols-1 row-cols-md-2 g-2 list-unstyled min-h-320" aria-label="ผู้ลงชื่อเล่นวันที่"></ul>
            <div class="mt-2 d-flex justify-content-end ">
              
              <small class="text-muted" id="todayDate" hidden></small>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Modal: Add/Edit Member -->
  <!-- MEMBER EDIT MODAL (canonical) -->
<div class="modal fade" id="memberEditModal" tabindex="-1" aria-labelledby="memberEditTitle" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="memberEditForm" novalidate>
        <div class="modal-header">
          <h5 class="modal-title">สมาชิก</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ปิด"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="memberId">
          <div class="mb-2">
            <label class="form-label" for="pmName">ชื่อ</label>
            <input id="pmName" class="form-control" required>
          </div>
          <div class="mb-2">
            <label class="form-label" for="pmLevel">ระดับ</label>
            <select id="pmLevel" class="form-select">
				   <option value="0">มือใหม่</option>
                  <option value="1">มือใหม่</option>
                  <option value="2">เบา</option>
                  <option value="3">กลาง</option>
                  <option value="4">หนัก</option>
				  <option value="5">โปร</option>
            </select>
          </div>
          <div class="mb-2">
            <label class="form-label" for="memStatus">สถานะ</label>
            <select id="memStatus" class="form-select">
              <option value="active">active</option>
              <option value="inactive">inactive</option>
            </select>
          </div>
          <fieldset class="mb-2">
            <legend class="form-label">เพิ่มลงก๊วน (เลือกได้หลายก๊วน)</legend>
            <div id="memGroupsWrap" class="d-flex flex-column gap-1 small"></div>
          </fieldset>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-danger me-auto" id="memberDeleteBtn">ลบ</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button>
          <button type="submit" class="btn btn-primary">บันทึก</button>
        </div>
      </form>
    </div>
  </div>
</div>
  </div>
</div>
        <!-- Modal: Player Profile -->
  <div class="modal fade" id="playerModalProfile" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><span id="playerName"></span> <small class="ms-2" id="playerLevelChip"></small></h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-md-4">
              <div class="border rounded p-3 h-100">
                <div class="mb-2"><strong>สรุป</strong></div>
                <div class="small text-muted">เคยมาเล่นแล้ว</div>
                <div class="display-6" id="playerAttendCount">0</div>
                <div class="small text-muted mt-3">จำนวนเกมทั้งหมด</div>
                <div class="h4" id="playerGameCount">0</div>
              </div>
            </div>
            <div class="col-md-8">
              <div class="border rounded p-3 h-100">
                <div class="mb-2"><strong>สรุปรายเดือน</strong></div>
                <div class="table-responsive">
                  <table class="table table-sm align-middle">
                    <thead class="table-light">
                      <tr>
                        <th>เดือน</th>
                        <th class="text-end">ครั้งที่มา</th>
                      </tr>
                    </thead>
                    <tbody id="playerMonthTbody"></tbody>
                  </table>
                </div>
              </div>
            </div>
            <div class="col-12">
              <div class="border rounded p-3">
                <div class="mb-2"><strong>ประวัติล่าสุด</strong></div>
                <ul id="playerRecentList" class="list-unstyled mb-0"></ul>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">ปิด</button>
        </div>
      </div>
    </div>
  </div><!-- Firebase compat SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<!-- EARLY_APP_INIT: ensure Firebase App is initialized before any module uses getAuth/getFirestore -->
<script src="assets/js/firebase_config.js"></script>


<!-- Modal: Add/Edit Player with group checkboxes -->
<!--<div class="modal fade" id="playerModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">ผู้เล่น</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-2">
          <label class="form-label" for="pmName">ชื่อ</label>
          <input id="pmName" class="form-control">
        </div>
        <div class="mb-2">
          <label class="form-label" for="pmLevel">ระดับ</label>
          <input id="pmLevel" type="number" class="form-control" value="0">
        </div>
        <div class="mb-2">
          <fieldset class="mb-2"><legend class="form-label">เพิ่มลงก๊วน (เลือกได้หลายก๊วน)</legend><div id="memGroupsWrap" class="d-flex flex-column gap-1 small"></div></fieldset>
          <div id="pmGroups" class="d-flex flex-column gap-1"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button>
        <button type="button" class="btn btn-primary" id="pmSave">บันทึก</button>
      </div>
    </div>
  </div>
</div>-->









<script id="topNavRouting">
/*(function(){
  // ลิงก์ “จัดการสมาชิก”
  var navMembers = document.querySelector('#topNav a.nav-link i.bi-people-fill');
  if (navMembers) {
    var a = navMembers.closest('a');
    if (a) a.setAttribute('href','index.html');
  }
  // ลิงก์ “จัดการคอร์ท”
  var navCourt = document.getElementById('navCourt');
  if (navCourt) {
    navCourt.setAttribute('href','court.html');
    navCourt.addEventListener('click', function(e){
      e.preventDefault();
      location.href = 'court.html';
    });
  }
})();*/
</script>


        <!-- OWNER_SWITCHER_MOUNT_START -->
    <script type="module">
      import * as GS from "./assets/js/group_state.js?v=20250812";
	  
      async function mountAndAuto(){
        try{
          await GS.waitForAuthReady();
          await GS.ensureOwnerMappings();
          const el = document.getElementById('ownerGroupSwitcher');
          if (el) await GS.mountOwnerGroupSwitcher(el);
          if (GS.getCurrentGroupId() === 'default'){
            const list = await GS.listOwnerGroups();
            let gid = list.length ? list[0].id : null;
            if (!gid){
              const mine = await GS.listMyGroups();
              gid = mine.length ? mine[0].id : null;
            }
            if (gid) GS.setCurrentGroupId(gid);
          }
        }catch(e){ console.warn('[switcher mount]', e); }
      }
      document.addEventListener('DOMContentLoaded', mountAndAuto);
      addEventListener('group:changed', ()=>{
        const el = document.getElementById('ownerGroupSwitcher');
        if (el) GS.mountOwnerGroupSwitcher(el);
      });
    </script>
    <!-- OWNER_SWITCHER_MOUNT_END -->

        <!-- BOOTSTRAP_MODAL_SAFETY_START -->
        <script>
        document.addEventListener('DOMContentLoaded', function(){
          try {
            var modals = Array.from(document.querySelectorAll('.modal[id]'));
            var triggers = Array.from(document.querySelectorAll('[data-bs-toggle="modal"]:not([data-bs-target])'));
            if (modals.length === 1 && triggers.length > 0) {
              var id = '#' + modals[0].id;
              triggers.forEach(function(t){ t.setAttribute('data-bs-target', id); });
            }
          } catch (e) { console.warn('[modal-safety]', e); }
        });
        </script>
        <!-- BOOTSTRAP_MODAL_SAFETY_END -->
        




<script type="module">
  import * as GS from "./assets/js/group_state.js?v=20250812";
  import { getFirestore, doc, getDoc, setDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  const db = getFirestore();
  const $  = (sel)=> document.querySelector(sel);
  const $$ = (sel)=> Array.from(document.querySelectorAll(sel));

  function getPlayerIdFromModal(){ return ($("#memberId")?.value || "").trim(); }
  function getPlayerNameFromModal(){ return ($("#pmName")?.value || "").trim(); }
  function getPlayerLevelFromModal(){ return parseInt($("#pmLevel")?.value || "0", 10) || 0; }

  async function listOwnerOrMemberGroups(){
    await GS.waitForAuthReady?.();
    await GS.ensureOwnerMappings?.();
    let groups = (await GS.listOwnerGroups?.()) || [];
    if (!groups.length && GS.listMyGroups) groups = await GS.listMyGroups();
    return groups; // [{id,name,myRole}]
  }

  async function populateGroupCheckboxes(playerId){
    const wrap = $("#memGroupsWrap");
    if (!wrap) return;
    wrap.innerHTML = '<div class="text-muted">กำลังโหลดก๊วน...</div>';

    const groups = await listOwnerOrMemberGroups();

    // ตรวจสมาชิกภาพเดิม
    const memberships = {};
    if (playerId){
      for (const g of groups){
        const snap = await getDoc(doc(db, "groups", g.id, "members_profiles", playerId));
        memberships[g.id] = snap.exists();
      }
    }

    wrap.innerHTML = "";
    if (!groups.length){
      wrap.innerHTML = '<div class="text-muted">ยังไม่มีก๊วน</div>';
      return;
    }

    for (const g of groups){
      const row = document.createElement("div");
      row.className = "form-check";

      const label = document.createElement("label");
      label.className = "form-check-label d-flex align-items-center gap-2";

      const input = document.createElement("input");
      input.className = "form-check-input";
      input.type = "checkbox";
      input.dataset.gid = g.id;
      if (memberships[g.id]) input.checked = true;

      const text = document.createTextNode((g.name || g.id) + (g.myRole === 'owner' ? "" : " (member)"));

      label.appendChild(input);
      label.appendChild(text);
      row.appendChild(label);
      wrap.appendChild(row);
    }
  }

  async function syncGroups(playerId, name, level){
    const wrap = $("#memGroupsWrap");
    if (!wrap) return;
    const checkedGids = $$('#memGroupsWrap input[type="checkbox"]:checked').map(i=> i.dataset.gid);
    const groups = await listOwnerOrMemberGroups();
    const want = new Set(checkedGids);

    for (const g of groups){
      const ref = doc(db, "groups", g.id, "members_profiles", playerId);
      if (want.has(g.id)){
        await setDoc(ref, { playerId, name, level }, { merge: true });
      } else {
        await deleteDoc(ref);
      }
    }
  }

  const modalEl = document.getElementById("memberEditModal");
  if (modalEl){
    ["show.bs.modal","shown.bs.modal"].forEach(evt=>{
      modalEl.addEventListener(evt, async ()=>{
        const pid = getPlayerIdFromModal();
        await populateGroupCheckboxes(pid || null);
      });
    });
  }

  // หลัง handler เดิมบันทึกแล้ว ค่อยซิงก์ก๊วนตาม checkbox
  const form = document.getElementById("memberEditForm");
  if (form){
    form.addEventListener("submit", ()=>{
      setTimeout(async ()=>{
        const pid   = getPlayerIdFromModal();
        if (!pid) return;                // กรณี handler เดิมยังไม่สร้าง id
        const name  = getPlayerNameFromModal();
        const level = getPlayerLevelFromModal();
        await syncGroups(pid, name, level);
      }, 120);
    }, { capture: true });
  }

  // เปลี่ยนก๊วนที่หัวเว็บ → ถ้าโมดัลเปิดอยู่ ให้รีเฟรชรายการ
  addEventListener('group:changed', async ()=>{
    if (document.querySelector('#memberEditModal.show')){
      const pid = getPlayerIdFromModal();
      await populateGroupCheckboxes(pid || null);
    }
  });
</script>



<!-- MEMBER_CLEAN_CRUD_START -->
<script type="module">
  import * as GS from "./assets/js/group_state.js?v=20250812";
  import {
    getFirestore, doc, getDoc, setDoc, updateDoc, addDoc, collection, deleteDoc,
    serverTimestamp, getDocs
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  import { getAuth } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

  const db = getFirestore();
  const $  = (sel)=> document.querySelector(sel);
  const $$ = (sel)=> Array.from(document.querySelectorAll(sel));


const LEVEL_TXT2 = {1:'มือใหม่',2:'เบา',3:'กลาง',4:'หนัก',5:'โปร'};
  function levelBadgeHtml(level){
    const txt = LEVEL_TXT2[level] || 'มือใหม่';
    const cls = txt==='มือใหม่' ? 'lv-1'
            : txt==='เบา'      ? 'lv-2'
            : txt==='กลาง'     ? 'lv-3'
            : txt==='หนัก'     ? 'lv-4'
            : txt==='โปร'      ? 'lv-5'
            : 'bg-light text-dark';
    return `<span class="badge ${cls} ms-2">${txt}</span>`;
  }


  function getPlayerId(){ return ($("#memberId")?.value || "").trim(); }
  function getPlayerName(){ return ($("#pmName")?.value || "").trim(); }
  function getPlayerLevel(){ return parseInt($("#pmLevel")?.value || "0", 10) || 0; }
  function getPlayerStatus(){ return ($("#memStatus")?.value || "active"); }

  async function listOwnerOrMemberGroups(){
    await (GS.waitForAuthReady?.() || Promise.resolve());
    await (GS.ensureOwnerMappings?.() || Promise.resolve());
    let groups = (await (GS.listOwnerGroups?.() || [])) || [];
    if (!groups.length && GS.listMyGroups) groups = await GS.listMyGroups();
    return groups; // [{id,name,myRole}]
  }

  async function populateGroupCheckboxes(playerId){
    const wrap = $("#memGroupsWrap");
    if (!wrap) return;
    wrap.innerHTML = '<div class="text-muted">กำลังโหลดก๊วน...</div>';
    const groups = await listOwnerOrMemberGroups();

    const memberships = {};
    if (playerId){
      for (const g of groups){
        const snap = await getDoc(doc(db, "groups", g.id, "members_profiles", playerId));
        memberships[g.id] = snap.exists();
      }
    }
    wrap.innerHTML = groups.length ? "" : '<div class="text-muted">ยังไม่มีก๊วน</div>';

    for (const g of groups){
      const row = document.createElement("div");
      row.className = "form-check";
      const label = document.createElement("label");
      label.className = "form-check-label d-flex align-items-center gap-2";
      const input = document.createElement("input");
      input.className = "form-check-input";
      input.type = "checkbox";
      input.dataset.gid = g.id;
      if (memberships[g.id]) input.checked = true;
      label.appendChild(input);
      label.appendChild(document.createTextNode((g.name || g.id) + (g.myRole==='owner' ? "" : " (member)")));
      row.appendChild(label);
      wrap.appendChild(row);
    }
  }

  async function upsertPlayerAndSyncGroups(){
    const auth = getAuth();
    const uid  = auth.currentUser?.uid;
    if (!uid) throw new Error("not signed in");

    const name   = getPlayerName();
    const level  = getPlayerLevel();
    const status = getPlayerStatus();
    if (!name) throw new Error("กรุณากรอกชื่อสมาชิก");

    // 1) owner catalog
    let pid = getPlayerId();
    if (!pid){
      const ref = await addDoc(collection(db, "users", uid, "players"), {
        name, level, status, createdAt: serverTimestamp()
      });
      pid = ref.id;
      $("#memberId").value = pid;
    } else {
      await setDoc(doc(db, "users", uid, "players", pid), {
        name, level, status, updatedAt: serverTimestamp()
      }, { merge: true });
    }

    // 2) sync groups
    const checked = $$('#memGroupsWrap input[type="checkbox"]:checked').map(i=> i.dataset.gid);
    const groups  = await listOwnerOrMemberGroups();
    const want = new Set(checked);

    for (const g of groups){
      const ref = doc(db, "groups", g.id, "members_profiles", pid);
      if (want.has(g.id)){
        await setDoc(ref, { playerId: pid, name, level, status }, { merge: true });
      } else {
        await deleteDoc(ref);
      }
    }
    return pid;
  }

  async function deletePlayerEverywhere(pidOpt){
 
  /* 👇 เพิ่มบรรทัดนี้ ให้เรียกใช้ได้จากโมดูลอื่น */
	window.deletePlayerEverywhere = deletePlayerEverywhere;	
	const uid = getAuth().currentUser?.uid;
    const pid = pidOpt || getPlayerId() || (typeof getPlayerIdFromModal==='function' ? getPlayerIdFromModal() : '');
    if (!uid || !pid) throw new Error("ไม่พบสมาชิกที่จะลบ");
    await deleteDoc(doc(db, "users", uid, "players", pid));
    const groups = await listOwnerOrMemberGroups();
    for (const g of groups){
      await deleteDoc(doc(db, "groups", g.id, "members_profiles", pid));

    }
  }

  // Modal open → เติมก๊วน
  const modalEl = document.getElementById("memberEditModal");
  if (modalEl){
    ["show.bs.modal","shown.bs.modal"].forEach(evt=>{
      modalEl.addEventListener(evt, async ()=>{ await populateGroupCheckboxes(getPlayerId() || null); });
    });
  }

  // Submit → Create/Update + Sync + Close + Reload
  const form = document.getElementById("memberEditForm");
  if (form){
    form.addEventListener("submit", async (e)=>{
      e.preventDefault();
      try{
        await upsertPlayerAndSyncGroups();
        try{
          const pidEl = document.getElementById('memberId');
          const pid = pidEl ? pidEl.value.trim() : '';
          const name = (document.getElementById('pmName')?.value || '').trim();
          const level = parseInt(document.getElementById('pmLevel')?.value || '1', 10) || 1;
          const gid = (GS.getCurrentGroupId? GS.getCurrentGroupId() : 'default');
          const di = document.getElementById('pickDate');
          const iso = di && di.value && di.value.length >= 10 ? di.value : (window.selectedDate || '');
          const key = iso ? iso.replaceAll('-', '') : (window.dateKey || '');
          if (pid && key){
            await setDoc(doc(db, 'groups', gid, 'play_sessions', key, 'participants', pid), { name, level }, { merge:true });
            try { di && di.dispatchEvent(new Event('change')); } catch(_e) {}
          }
        }catch(_e){}
        bootstrap.Modal.getOrCreateInstance(document.getElementById("memberEditModal")).hide();
        await reloadMemberAll();
      }catch(err){
        console.error("[save member]", err);
        alert(err?.message || "บันทึกไม่สำเร็จ");
      }
    });
  }

  // Delete
  const delBtn = document.getElementById("memberDeleteBtn");
  if (delBtn){
    delBtn.addEventListener("click", async ()=>{
      if (!confirm("ยืนยันการลบสมาชิกนี้?")) return;
      try{
        await deletePlayerEverywhere();
        bootstrap.Modal.getOrCreateInstance(document.getElementById("memberEditModal")).hide();
        await reloadMemberAll();
      }catch(err){
        console.error("[delete member]", err);
        alert(err?.message || "ลบไม่สำเร็จ");
      }
    });
  }

  // รายการสมาชิกในก๊วนปัจจุบัน
  async function reloadMemberAll(){
	 
    const box = document.getElementById("memberAll");
    if (!box) return;
    box.innerHTML = '<div class="text-muted">กำลังโหลด...</div>';
    const gid = GS.getCurrentGroupId ? GS.getCurrentGroupId() : 'default';
    try{
      const snap = await getDocs(collection(db, "groups", gid, "members_profiles"));
      if (snap.size === 0){ box.innerHTML = '<div class="text-muted">ยังไม่มีสมาชิกในก๊วนนี้</div>'; return; }
      const items = [];
      snap.forEach(d=> items.push({ id: d.id, ...(d.data()||{}) }));
      items.sort((a,b)=> (a.name||'').localeCompare(b.name||''));
         box.innerHTML = items.map(x=>
      '<div class="d-flex justify-content-between align-items-center border rounded-3 p-2 mb-2">'+
        '<div><div class="fw-semibold">'+
           (x.name||x.id) + levelBadgeHtml(x.level ?? 1) +  // 👈 badge ต่อท้ายชื่อ
        '</div>'+
        '<div class="text-muted small">สถานะ: '+(x.status||'active')+'</div></div>'+
        '<div><button class="btn btn-sm btn-outline-secondary" data-edit="'+x.id+'">แก้ไข</button></div>'+
      '</div>'
    ).join("");
      box.querySelectorAll('button[data-edit]').forEach(btn=>{
        btn.addEventListener('click', async (e)=>{
          const pid = e.currentTarget.getAttribute('data-edit');
          try{
            const uid = getAuth().currentUser?.uid;
            let data = null;
            if (uid){
              const ps = await getDoc(doc(db, "users", uid, "players", pid));
              data = ps.exists() ? ps.data() : null;
            }
            const item = items.find(i=> i.id === pid);
            $("#memberId").value = pid;
            $("#pmName").value = data?.name || item?.name || '';
            $("#pmLevel").value = (data?.level ?? item?.level ?? 0);
            $("#memStatus").value = data?.status || item?.status || 'active';
            await populateGroupCheckboxes(pid);
            bootstrap.Modal.getOrCreateInstance(document.getElementById("memberEditModal")).show();
          }catch(err){ console.warn(err); }
        });
      });
    }catch(e){
      console.error("[reloadMemberAll]", e);
      box.innerHTML = '<div class="text-danger">โหลดสมาชิกไม่สำเร็จ</div>';
    }
  }

  // ปุ่มเพิ่ม
  const addBtn = document.getElementById("btnAddMember");
  if (addBtn){
    addBtn.addEventListener("click", ()=>{
      $("#memberId").value = "";
      $("#pmName").value = "";
      $("#pmLevel").value = "0";
      $("#memStatus").value = "active";
      populateGroupCheckboxes(null);
    });
  }

  document.addEventListener("DOMContentLoaded", reloadMemberAll);
  addEventListener("group:changed", reloadMemberAll);
</script>
<!-- MEMBER_CLEAN_CRUD_END -->






<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>




<!-- MEMBER_TODAY_BLOCK_START (fixed ids: memberSearch, memberLevelFilter, pickDate) -->
<script type="module">


function levelBadge(level) {
  let badgeClass = '';
  switch (level) {
    case 'มือใหม่':
      badgeClass = 'lv-1';
      break;
    case 'เบา':
      badgeClass = 'lv-2';
      break;
    case 'กลาง':
      badgeClass = 'lv-3';
      break;
    case 'หนัก':
      badgeClass = 'lv-4';
      break;
    case 'โปร':
      badgeClass = 'lv-5';
      break;
    default:
      badgeClass = 'bg-light text-dark bg-opacity-50';
  }
  return `<span class="badge ${badgeClass} ms-2">${level}</span>`;
}



function levelBadge_text(levelText) {
    let badgeClass = '';
    switch (levelText) {
      case 'มือใหม่': badgeClass = 'lv-1'; break;
      case 'เบา':      badgeClass = 'lv-2';   break;
      case 'กลาง':     badgeClass = 'lv-3'; break;
      case 'หนัก':     badgeClass = 'lv-4'; break;
      case 'โปร':      badgeClass = 'lv-5';    break;
      default:         badgeClass = 'bg-light text-dark';
    }
    return `<span class="badge ${badgeClass} ms-2">${levelText}</span>`;
  }


  import * as GS from "./assets/js/group_state.js?v=20250812";
  import {
    getFirestore, collection, doc, getDoc, getDocs, setDoc, deleteDoc, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  const db = getFirestore();
  const $  = (s)=> document.querySelector(s);

  // ระดับ: เก็บเป็น 1..5 (มือใหม่..โปร)
  const LEVEL_MAP = { 'มือใหม่':1, 'เบา':2, 'กลาง':3, 'หนัก':4, 'โปร':5 };
  const LEVEL_TXT = { 1:'มือใหม่', 2:'เบา', 3:'กลาง', 4:'หนัก', 5:'โปร' };

  function normalizeLevel(v){
    if (typeof v === 'number') return Math.max(1, Math.min(5, v|0));
    if (v == null) return 1;
    const s = String(v).trim();
    if (s === '') return 1;
    if (Object.prototype.hasOwnProperty.call(LEVEL_MAP, s)) return LEVEL_MAP[s];
    const n = parseInt(s,10);
    return isNaN(n) ? 1 : Math.max(1, Math.min(5, n));
  }

  // วันที่
  const toKey = (d)=> {
    const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), day=String(d.getDate()).padStart(2,'0');
    return `${y}${m}${day}`;
  };
  const keyToInput = (k)=> `${k.slice(0,4)}-${k.slice(4,6)}-${k.slice(6,8)}`;
  const keyToLabel = (k)=> `${k.slice(6,8)}/${k.slice(4,6)}/${k.slice(0,4)}`;
  const inputToKey = (val)=> (!val||val.length<10) ? toKey(new Date()) : (val.slice(0,4)+val.slice(5,7)+val.slice(8,10));

  // ใช้ id จริงในหน้า
  const searchInput = $('#memberSearch');
  const levelSel    = $('#memberLevelFilter');  // value: "0"(ทั้งหมด) | "1".."5"
  const dateInput   = $('#pickDate');           // <input type="date">
  const dateLabelH  = $('#dayDateText');        // หัวการ์ด
  const dateLabelB  = $('#todayDate');          // มุมล่างขวาการ์ด

  // สถานะ
  const state = { members: [], todays: [], search: '', level: '0' /*0=ทั้งหมด*/ };

  // วันที่ที่เลือก
  let selectedKey = (dateInput && dateInput.value) ? inputToKey(dateInput.value) : toKey(new Date());

  // path
  const groupId   = ()=> (GS.getCurrentGroupId ? GS.getCurrentGroupId() : 'default');
  const membersCol= ()=> collection(db, 'groups', groupId(), 'members_profiles');
  const playCol   = ()=> collection(db, 'groups', groupId(), 'play_sessions', selectedKey, 'participants');
  const playDoc   = (pid)=> doc(db, 'groups', groupId(), 'play_sessions', selectedKey, 'participants', pid);

  

  // --- Clear All in "ผู้ลงชื่อเล่นวันที่" ---
  const clearBtn = document.getElementById('btnClearToday');
  if (clearBtn){
    clearBtn.addEventListener('click', async ()=>{
      try{
        // Confirm if there is anything to clear
        // Reload current list to be sure
        await loadToday();
        if (!state.todays.length){
          alert('ยังไม่มีรายชื่อวันนี้');
          return;
        }
        if (!confirm('ล้างรายชื่อผู้ลงชื่อเล่นทั้งหมดสำหรับวันนี้?')) return;

        clearBtn.disabled = true;

        // Delete all docs under play_sessions/{selectedKey}/participants
        const snap = await getDocs(playCol());
        const tasks = [];
        snap.forEach(d=> tasks.push(deleteDoc(d.ref).catch(()=>{})));
                await Promise.all(tasks);

        await reloadAll();
      } catch(e){
        console.error('[clear today]', e);
        alert('ล้างรายชื่อวันนี้ไม่สำเร็จ');
      } finally {
        clearBtn.disabled = false;
      }
    });
  }

// โหลด
  async function loadMembers(){
    const snap = await getDocs(membersCol());
    const arr = [];
    snap.forEach(d=>{
      const v = d.data()||{};
      arr.push({ id:d.id, name:v.name||'', level: normalizeLevel(v.level), status: v.status||'active' });
    });
    arr.sort((a,b)=> (a.name||'').localeCompare(b.name||''));
    state.members = arr;
  }
  async function loadToday(){
    const snap = await getDocs(playCol());
    const arr = [];
    snap.forEach(d=>{
      const v = d.data()||{};
      arr.push({ id:d.id, name:v.name||'', level: normalizeLevel(v.level), arrived: !!v.arrived });
    });
    arr.sort((a,b)=> (a.name||'').localeCompare(b.name||''));
    state.todays = arr;
  }

  // ฟิลเตอร์ (ใช้เลข ไม่อิงข้อความ)
  function filteredMembers(){
    const q  = (state.search||'').trim().toLowerCase();
    const lv = state.level; // '0'=ทั้งหมด | '1'..'5'
    return state.members.filter(x=>{
      if (q && (x.name||'').toLowerCase().indexOf(q) === -1) return false;
      if (lv && lv !== '0' && String(x.level) !== lv) return false;
      return true;
    });
  }

  // UI helpers
  function btnIcon(cls, title, bi){
    const b = document.createElement('button');
    b.className = cls; b.title = title;
    b.innerHTML = '<i class="bi '+bi+'"></i>';
    return b;
  }






  function renderMemberRow(x){
    const row = document.createElement('div');
    row.className = 'd-flex align-items-center justify-content-between border rounded-3 p-1 mb-1';
    row.draggable = true;
    row.dataset.pid = x.id;
    row.addEventListener('dragstart', e=> e.dataTransfer.setData('text/plain', x.id));

    const left = document.createElement('div');
    const l1 = document.createElement('div');
    l1.className = 'fw-semibold';
    l1.innerHTML = (x.name || x.id) + levelBadge(LEVEL_TXT[x.level] || 'มือใหม่') ;  // 👈 badge ต่อท้ายชื่อ
    // บรรทัดระดับเดิมลบออก (ไม่ต้องมี l2 อีก)
    left.append(l1);

    const right = document.createElement('div');
    right.className = 'd-flex align-items-center gap-2';

    const bProfile = btnIcon('btn btn-sm btn-outline-secondary','ดูโปรไฟล์','bi-person-vcard');
    bProfile.onclick = ()=> showPlayerModal(x.id);   // 👈 เปิด modal โปรไฟล์จริง

    const bEdit = btnIcon('btn btn-sm btn-outline-secondary','แก้ไข','bi-pencil-square');
    bEdit.onclick = ()=> {
      const mid = document.getElementById('memberEditModal');
      if (!mid) return;
      const $g = (id)=> document.getElementById(id);
      $g('memberId').value = x.id;
      $g('pmName').value   = x.name || '';
      $g('pmLevel').value  = String(x.level || 1);
      if ($g('memStatus')) $g('memStatus').value = x.status || 'active';
      if (window.populateGroupCheckboxes) window.populateGroupCheckboxes(x.id);
      bootstrap.Modal.getOrCreateInstance(mid).show();
    };

    const bDel = btnIcon('btn btn-sm btn-outline-danger','ลบ','bi-trash');
    bDel.onclick = async ()=> {
      if (!confirm('ยืนยันลบสมาชิกนี้?')) return;
      const rowEl = row;
      try{
        // ลบออกจากรายชื่อวันนี้ (ถ้ามี)
        await deleteDoc(playDoc(x.id)).catch(()=>{});
        // ลบโปรไฟล์ออกจากฐานสมาชิกทั้งหมดด้วย
        if (window.deletePlayerEverywhere) {
          const hid = document.getElementById('memberId');
          if (hid) hid.value = x.id;
          await window.deletePlayerEverywhere(x.id);
        }
      } finally {
        try { const fresh = renderMemberRow(x); rowEl.replaceWith(fresh); } catch(_e) {}
        await reloadAll();
      }
    };

    const joined = state.todays.some(t=> t.id === x.id);
    const bJoin = btnIcon(joined ? 'btn btn-sm btn-success' : 'btn btn-sm btn-primary',
                          'เลือกเข้าเล่นวันนี้', joined ? 'bi-person-check' : 'bi-person-plus');
    bJoin.onclick = ()=> toggleJoinToday(x);

    right.append(bProfile,bEdit,bJoin); //bDel,
    row.append(left,right);
    return row;
  }

  
function renderTodayRow(x){
  // <li class="col"> wrapper to enable 2-column grid inside UL
  const li = document.createElement('li');
  li.className = 'col';

  const row = document.createElement('div');
  row.className = 'd-flex align-items-center justify-content-between border rounded-3 p-1';
  row.dataset.pid = x.id;
  row.draggable = true;
  row.addEventListener('dragstart', e=> e.dataTransfer.setData('text/plain', x.id));

  const left = document.createElement('div');
  const l1 = document.createElement('div');
  l1.className = 'fw-semibold';
  l1.innerHTML = (x.name || x.id) + levelBadge(LEVEL_TXT[x.level] || 'มือใหม่');  // badge ต่อท้ายชื่อ
  left.append(l1);

  const right = document.createElement('div');
  right.className = 'd-flex align-items-center gap-2 ';

  const wrap = document.createElement('div');
  wrap.className = 'form-check form-switch';
  const sw = document.createElement('input');
  sw.className = 'form-check-input'; sw.type = 'checkbox'; sw.id = 'arrived_'+x.id; sw.checked = !!x.arrived;
  const lab = document.createElement('label');
  lab.className = 'form-check-label small' ; lab.setAttribute('for', sw.id);
  lab.textContent = sw.checked ? 'มาแล้ว' : 'ยังไม่มา';
  sw.addEventListener('change', async ()=>{
    await setDoc(playDoc(x.id), { arrived: sw.checked }, { merge: true });
    lab.textContent = sw.checked ? 'มาแล้ว' : 'ยังไม่มา';
  });
  wrap.append(sw,lab);

  const bCancel = btnIcon('btn btn-sm btn-outline-danger','ยกเลิก','bi-x-circle');
  bCancel.onclick = ()=> cancelJoinToday(x.id);
 
  right.append(wrap,bCancel);
  row.append(left,right);

  li.appendChild(row);
  return li;
}


  async function toggleJoinToday(m){
    const p = await getDoc(playDoc(m.id));
    if (p.exists()) await deleteDoc(playDoc(m.id));
    else {
      const g = (GS.getCurrentGroupId? GS.getCurrentGroupId() : 'default');
      const iso = (document.getElementById('pickDate')?.value || '').slice(0,10);
      const useIso = /^\d{4}-\d{2}-\d{2}$/.test(iso) ? iso : (window.selectedDate || '');
      const day = useIso ? new Date(useIso) : new Date();
      await setDoc(playDoc(m.id), {
        playerId:m.id, pid:m.id, gid: g,
        name:m.name||'', level:m.level||1,
        arrived:false, joinedAt: serverTimestamp(),
        dayTs: day
      }, { merge:true });
    }
    await reloadAll();
  }
  async function cancelJoinToday(pid){
    await deleteDoc(playDoc(pid));
    await reloadAll();
  }

  // Drag & Drop targets
  const todayBox = document.getElementById('todayList');
  if (todayBox){
    todayBox.addEventListener('dragover', e=> e.preventDefault());
    todayBox.addEventListener('drop', async (e)=>{
      e.preventDefault();
      const pid = e.dataTransfer.getData('text/plain'); if (!pid) return;
      const m = state.members.find(v=> v.id===pid); if (m) await toggleJoinToday(m);
    });
  }
  const allBox = document.getElementById('memberAll');
  if (allBox){
    allBox.addEventListener('dragover', e=> e.preventDefault());
    allBox.addEventListener('drop', async (e)=>{
      e.preventDefault();
      const pid = e.dataTransfer.getData('text/plain'); if (!pid) return;
      await cancelJoinToday(pid);
    });
  }

  function paint(){
    // อัปเดตวันที่ที่หัว/ท้าย
    if (dateLabelH) dateLabelH.textContent = keyToLabel(selectedKey);
    if (dateLabelB) dateLabelB.textContent = keyToLabel(selectedKey);

    // ซ้าย: สมาชิกทั้งหมด (ตามฟิลเตอร์)
    const box = document.getElementById('memberAll');
    if (box){
      const list = filteredMembers();
      box.innerHTML = '';
      if (!list.length){
        const none = document.createElement('div');
        none.className = 'text-muted'; none.textContent = 'ยังไม่มีสมาชิกตามเงื่อนไข';
        box.appendChild(none);
      }else{
        list.forEach(x=> box.appendChild(renderMemberRow(x)));
      }
    }
    // ขวา: เล่นวันนี้
    const tbox = document.getElementById('todayList');
    if (tbox){
      tbox.innerHTML = '';
if (!state.todays.length) {
  const li = document.createElement('li');
  li.className = 'col-12';
  li.innerHTML = '<div class="text-muted">ยังไม่มีใครลงชื่อวันนี้</div>';
  tbox.appendChild(li);
} else {
        state.todays.forEach(x=> tbox.appendChild(renderTodayRow(x)));
		rightCount.innerText = "จำนวนรวม " + state.todays.length + " คน";
      }
    }
  }

  async function reloadAll(){
    await Promise.all([loadMembers(), loadToday()]);
    paint();
  }

  // Bind ค้นหา/ฟิลเตอร์/ปฏิทิน
  if (searchInput){ searchInput.addEventListener('input', ()=>{ state.search = searchInput.value || ''; state.page = 1; paint(); }); }
  if (levelSel){
    // ค่า "0" = ทั้งหมด
    state.level = levelSel.value || '0';
    levelSel.addEventListener('change', ()=>{ state.level = levelSel.value || '0'; paint(); });
  }
  if (dateInput){
    // ถ้าไม่มีค่า ให้ตั้งเป็นวันนี้ตาม selectedKey
    if (!dateInput.value) dateInput.value = keyToInput(selectedKey);
    dateInput.addEventListener('change', async ()=>{
      selectedKey = inputToKey(dateInput.value);
      await reloadAll();
    });
  }

  document.addEventListener('DOMContentLoaded', reloadAll);
  addEventListener('group:changed', reloadAll);
</script>
<!-- MEMBER_TODAY_BLOCK_END -->




<script type="module">
  import {
    getFirestore, collectionGroup, query, where, orderBy, getDocs, doc, getDoc, limit
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  import * as GS from "./assets/js/group_state.js?v=20250812";

  const db = getFirestore();
  const gid = () => (GS.getCurrentGroupId ? GS.getCurrentGroupId() : 'default');
  const $ = s => document.querySelector(s);

  const LEVEL_TXT = {1:'มือใหม่',2:'เบา',3:'กลาง',4:'หนัก',5:'โปร'};
  function levelBadge(levelText) {
    let c = 'bg-light text-dark';
    if (levelText==='มือใหม่') c='bg-secondary';
    else if (levelText==='เบา') c='bg-success';
    else if (levelText==='กลาง') c='bg-info text-dark';
    else if (levelText==='หนัก') c='bg-warning text-dark';
    else if (levelText==='โปร') c='bg-danger';
    return `<span class="badge ${c} ms-2">${levelText}</span>`;
  }

  // helpers
  function startOfMonth(d){ return new Date(d.getFullYear(), d.getMonth(), 1, 0,0,0,0); }
  function startOfNextMonth(d){ return new Date(d.getFullYear(), d.getMonth()+1, 1, 0,0,0,0); }
  function prevMonthRange(d){ // [start, end)
    const end = startOfMonth(d);
    const start = new Date(end.getFullYear(), end.getMonth()-1, 1, 0,0,0,0);
    return [start, end];
  }
  function toKey(dt){
    const y=dt.getFullYear(), m=String(dt.getMonth()+1).padStart(2,'0'), day=String(dt.getDate()).padStart(2,'0');
    return `${y}${m}${day}`;
  }
  function keyToLabel(k){ return `${k.slice(6,8)}/${k.slice(4,6)}/${k.slice(0,4)}`; }
  function ymLabel(d){ return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`; }

  // แคช 5 นาที
  const cache = new Map(); // key: `${pid}:cur` | `${pid}:prev` -> {ts,data}

  async function showPlayerModal(playerId){
    // เปิด modal พร้อม skeleton ไว ๆ ก่อน
    $('#playerName').textContent = 'กำลังโหลด...';
    $('#playerLevelChip').innerHTML = '';
    $('#playerAttendCount').textContent = '—';
    $('#playerGameCount').textContent = '—';
    $('#playerMonthTbody').innerHTML = '<tr><td colspan="2" class="text-muted">กำลังโหลด...</td></tr>';
    $('#playerRecentList').innerHTML = '<li class="text-muted">กำลังโหลด...</li>';
    bootstrap.Modal.getOrCreateInstance(document.getElementById('playerModalProfile')).show();

    const now = Date.now();
    const curKey = `${playerId}:cur`;
    const prevKey = `${playerId}:prev`;

    // ช่วงเวลา
    const today = new Date();
    const curStart = startOfMonth(today);
    const curEnd = startOfNextMonth(today);
    const [prevStart, prevEnd] = prevMonthRange(today);

    // ----- 1) เดือนปัจจุบัน (รายละเอียด) -----
    let curData = cache.get(curKey);
    if (!(curData && now - curData.ts < 5*60*1000)) {
      const qCur = query(
        collectionGroup(db, 'participants'),
        where('gid','==', gid()),
        where('pid','==', playerId),
        where('dayTs','>=', curStart),
        where('dayTs','<', curEnd),
        orderBy('dayTs','desc'),
        limit(62) // เดือนนึงพอ
      );
      const curSnap = await getDocs(qCur);
      let list = curSnap.docs.map(d => d.data());

            /* Fallback: if no docs (older data missing pid/gid/dayTs),
         query by playerId then derive dayTs from parent key */
      if (!list.length) {
        const qAlt = query(
          collectionGroup(db, 'participants'),
          where('playerId','==', playerId),
          limit(400)
        );
        const altSnap = await getDocs(qAlt);
        const tmp = altSnap.docs.map(docSnap => {
          const data = docSnap.data();
          // parent path: groups/{gid}/play_sessions/{key}/participants/{pid}
          const psRef = docSnap.ref.parent.parent; // play_sessions/{key}
          let dayTs = data.dayTs;
          if (!dayTs && psRef) {
            const key = psRef.id; // YYYYMMDD
            const iso = `${key.slice(0,4)}-${key.slice(4,6)}-${key.slice(6,8)}`;
            dayTs = new Date(iso);
          }
          return {
            ...data,
            dayTs
          };
        }).filter(v => !!v.dayTs && v.dayTs >= curStart && v.dayTs < curEnd);
        tmp.sort((a,b)=> (b.dayTs?.toMillis?.()||b.dayTs) - (a.dayTs?.toMillis?.()||a.dayTs));
        list = tmp;
      }
// สรุปชื่อ/ระดับจากเอกสารล่าสุด (ถ้าไม่มี ค่อยอ่านโปรไฟล์)
      let name = list[0]?.name || null;
      let levelNum = parseInt(list[0]?.level ?? 1, 10) || 1;

      if (!name) {
        // fallback โปรไฟล์
        const profSnap = await getDoc(doc(db,'groups',gid(),'members_profiles',playerId));
        const prof = profSnap.exists() ? profSnap.data() : {};
        name = prof.name || playerId;
        levelNum = parseInt(prof.level ?? 1, 10) || 1;
      }

      const recent = list.map(v=>{
        const dt = v.dayTs?.toDate?.() || new Date(v.dayTs);
        return { key: toKey(dt), arrived: !!v.arrived };
      });

      curData = {
        name, levelTxt: LEVEL_TXT[levelNum] || 'มือใหม่',
        attendCount: recent.length,
        recent
      };
      cache.set(curKey, { ts: now, data: curData });
    }

    // ----- 2) เดือนก่อนหน้า (สรุปจำนวนครั้งอย่างเดียว) -----
    let prevData = cache.get(prevKey);
    if (!(prevData && now - prevData.ts < 5*60*1000)) {
      const qPrev = query(
        collectionGroup(db, 'participants'),
        where('gid','==', gid()),
        where('pid','==', playerId),
        where('dayTs','>=', prevStart),
        where('dayTs','<', prevEnd),
        orderBy('dayTs','desc')
      );
      const prevSnap = await getDocs(qPrev);
      prevData = { count: prevSnap.size };
      cache.set(prevKey, { ts: now, data: prevData });
    }

    // ----- วาดผล -----
    renderProfileMonthScoped(curData, {
      curMonthLabel: ymLabel(today),
      curCount: curData.attendCount,
      prevMonthLabel: ymLabel(prevStart),
      prevCount: prevData.count
    });
  }

  function renderProfileMonthScoped(curData, summary){
    const { name, levelTxt, attendCount, recent } = curData;
    $('#playerName').textContent = name;
    $('#playerLevelChip').innerHTML = levelBadge(levelTxt);

    // แปลความหมายใหม่: "เคยมาเล่นแล้ว" = เดือนนี้
    $('#playerAttendCount').textContent = String(attendCount);
    // เกมรวมยัง 0 จนกว่าจะเชื่อมกับแมตช์จริง
    $('#playerGameCount').textContent = '0';

    // ตาราง "สรุปรายเดือน" => แสดง 2 แถว: เดือนนี้ + เดือนก่อน
    const tbody = $('#playerMonthTbody'); tbody.innerHTML = '';
    tbody.insertAdjacentHTML('beforeend',
      `<tr><td>${summary.curMonthLabel}</td><td class="text-end">${summary.curCount}</td></tr>`);
    tbody.insertAdjacentHTML('beforeend',
      `<tr><td>${summary.prevMonthLabel}</td><td class="text-end">${summary.prevCount}</td></tr>`);

    // รายการล่าสุด: แสดงเฉพาะ "เดือนนี้"
    const ul = $('#playerRecentList'); ul.innerHTML = '';
    if (!recent.length){
      ul.innerHTML = '<li class="text-muted">— เดือนนี้ยังไม่มีข้อมูล —</li>';
    } else {
      recent.forEach(r=>{
        const li = document.createElement('li');
        li.textContent = `${keyToLabel(r.key)} — ${r.arrived ? 'มาแล้ว' : 'ยังไม่มา'}`;
        ul.appendChild(li);
      });
    }
  }

  // ให้ปุ่ม “ดูโปรไฟล์” เรียกใช้ได้
  window.showPlayerModal = showPlayerModal;
</script>




<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/th.js"></script>
<!-- PICKDATE_MARKS_ADDON_START -->
<script type="module">
  import * as GS from "./assets/js/group_state.js?v=20250812";
  import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  const db = getFirestore();
  const pick = document.getElementById('pickDate');
  if (pick) { try{ pick.setAttribute('type','text'); }catch(_){} if(!pick.value){ const d=new Date(); pick.value = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; } }
  if (pick && window.flatpickr){
    const getGroupId = ()=> (GS && typeof GS.getCurrentGroupId === 'function') ? GS.getCurrentGroupId() : 'default';

    const keyFromDateObj = (d)=> {
      const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), dd=String(d.getDate()).padStart(2,'0');
      return ''+y+m+dd;
    };

    let markedDays = new Set();
    let cachedYYYYMM = null;
    let cachedGroup = null;

    async function loadMarksForMonth(year, month){
      const yyyymm = String(year) + String(month).padStart(2,'0');
      const gid = getGroupId();
      if (cachedYYYYMM === yyyymm && cachedGroup === gid) return;
      cachedYYYYMM = yyyymm;
      cachedGroup = gid;
      markedDays = new Set();

      const last = new Date(year, month, 0).getDate();
      const tasks = [];
      for (let d=1; d<=last; d++){
        const key = String(year) + String(month).padStart(2,'0') + String(d).padStart(2,'0');
        const colRef = collection(db, "groups", gid, "play_sessions", key, "participants");
        tasks.push(getDocs(colRef).then(snap=>{ if (!snap.empty) markedDays.add(key); }).catch(()=>{}));
      }
      await Promise.all(tasks);
    }

    async function refreshMarks(instance){
      const y = instance.currentYear;
      const m = instance.currentMonth + 1;
      await loadMarksForMonth(y, m);
      instance.redraw();
    }

    const fp = flatpickr(pick, { 
        locale: (flatpickr.l10ns && flatpickr.l10ns.th) ? flatpickr.l10ns.th : undefined,
        altInput: true,
        altFormat: 'd/m/Y',
        disableMobile: true,

      
      dateFormat: 'Y-m-d',
      defaultDate: pick.value || undefined,
      onDayCreate: function(_, __, inst, dayElem){
        try{
          const dateObj = dayElem.dateObj || (dayElem.dateObj = new Date(dayElem.getAttribute('aria-label')));
          if (!dateObj || isNaN(dateObj.getTime())) return;
          const key = keyFromDateObj(dateObj);
          if (markedDays.has(key)){
            dayElem.classList.add('has-play');  // apply directly to the day element
          }else{
            dayElem.classList.remove('has-play');
          }
        }catch(e){}
      },
      onReady: async function(_, __, inst){ await refreshMarks(inst); },
      onMonthChange: async function(_, __, inst){ await refreshMarks(inst); },
      onYearChange: async function(_, __, inst){ await refreshMarks(inst); },
      onOpen: async function(_, __, inst){ await refreshMarks(inst); }
    });

    // If group changes elsewhere, try to refresh marks
    window.addEventListener('group:changed', ()=> { if (fp) refreshMarks(fp); });
  }
</script>
<!-- PICKDATE_MARKS_ADDON_END -->


<script type="module">
import { getAuth, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
const auth = getAuth();
document.getElementById('btnLogout').addEventListener('click', async ()=>{
	
  try {
    await signOut(auth);
    location.href = 'login.html';
  } catch(e) {
    alert(e.message);
  }
});
</script>
<script>


(function(){
  const PER_PAGE = 12;
  const memberAll = document.getElementById('memberAll');
  if (!memberAll) return;

  const leftCount = document.getElementById('leftCount');   // ถ้ามี
  const pagerUL   = document.getElementById('pagination');  // ถ้ามี

  const state = { page: 1, perPage: PER_PAGE };

  
// เลือก "แถวสมาชิก" ให้ตรงกับโครงสร้าง UL/LI ของคุณ
function queryItemNodes(){
  // เคสหลักของคุณ: ul#memberAll > li.list-group-item
  let nodes = memberAll.querySelectorAll(':scope > li.list-group-item');
  if (nodes.length) return Array.from(nodes);

  // สำรอง: ul#memberAll > li (ถ้ามี li แต่ไม่ได้ใส่คลาส)
  nodes = memberAll.querySelectorAll(':scope > li');
  if (nodes.length) return Array.from(nodes);

  // สำรองสุดท้าย: ลูก element ใดๆ ที่ไม่ใช่ placeholder
  return Array.from(memberAll.children).filter(el =>
    el.nodeType === 1 && !el.classList.contains('text-muted')
  );
}

  function clampPage(totalPages){
    if (state.page < 1) state.page = 1;
    if (state.page > totalPages) state.page = totalPages;
  }

  // ซ่อน/โชว์ด้วย d-none (ชนะสไตล์อื่นๆ)
function applyPagination(){
  const items = queryItemNodes();
  const total = items.length;
  const perPage = state.perPage;
  const totalPages = Math.max(1, Math.ceil((total || 0) / perPage));

  clampPage(totalPages);

  const start = (state.page - 1) * perPage;
  const end   = Math.min(start + perPage, total);

  // ใช้ d-none เพื่อซ่อน/โชว์อย่างเด็ดขาด
  items.forEach((el, idx) => {
    if (idx >= start && idx < end) {
      el.classList.remove('d-none');
    } else {
      el.classList.add('d-none');
    }
  });

  if (leftCount){
    leftCount.textContent = total ? `แสดง ${start+1}–${end} จาก ${total}` : 'ไม่มีรายการ';
  }

  if (pagerUL){
    pagerUL.innerHTML = '';
    const makeLi = (label, disabled, onClick, isActive=false)=>{
      const li = document.createElement('li');
      li.className = 'page-item' + (disabled ? ' disabled' : '') + (isActive ? ' active' : '');
      const a = document.createElement('a');
      a.className = 'page-link'; a.href = '#'; a.textContent = label;
      if (!disabled) a.addEventListener('click', (e)=>{ e.preventDefault(); onClick(); });
      li.appendChild(a);
      return li;
    };

    pagerUL.appendChild(makeLi('‹', state.page <= 1, ()=>{ state.page--; applyPagination(); }));

    const windowSize = 5;
    let pStart = Math.max(1, state.page - Math.floor(windowSize/2));
    let pEnd   = Math.min(totalPages, pStart + windowSize - 1);
    pStart = Math.max(1, pEnd - windowSize + 1);

    for (let p = pStart; p <= pEnd; p++){
      pagerUL.appendChild(makeLi(String(p), false, ()=>{ state.page = p; applyPagination(); }, p === state.page));
    }

    pagerUL.appendChild(makeLi('›', state.page >= totalPages, ()=>{ state.page++; applyPagination(); }));
  }
}

  // debounce เล็กน้อยเวลาค้นหา/เปลี่ยนระดับ
  function debounce(fn, ms){ let t; return (...a)=>{ clearTimeout(t); t = setTimeout(()=>fn.apply(null,a), ms); }; }

  const searchInput = document.getElementById('memberSearch');
  if (searchInput){
    searchInput.addEventListener('input', debounce(()=>{ state.page = 1; applyPagination(); }, 200));
  }
  const levelFilter = document.getElementById('memberLevelFilter');
  if (levelFilter){
    levelFilter.addEventListener('change', ()=>{ state.page = 1; applyPagination(); });
  }

  // สังเกตการเติมรายการใหม่ (เมื่อ paint() ของคุณทำงาน)
  const mo = new MutationObserver(debounce(()=>{
    const total = queryItemNodes().length;
    const totalPages = Math.max(1, Math.ceil(total / state.perPage));
    clampPage(totalPages);
    applyPagination();
  }, 50));
  mo.observe(memberAll, { childList: true });

  // เฝ้ารอ “มีรายการจริง” ช่วงแรก (บางครั้งเติมรายการช้า)
  (function waitForItems(attempt=0){
    const items = queryItemNodes();
    if (items.length > 0 || attempt > 40) { // รอ ~2วินาที (40 * 50ms)
      applyPagination();
      return;
    }
    setTimeout(()=> waitForItems(attempt+1), 50);
  })();

  // ถ้ามีอีเวนต์สลับก๊วน/วันที่ในแอป
  window.addEventListener('group:changed', ()=>{ state.page = 1; applyPagination(); });
})();
</script>

<script type="module">
  import * as GS from "./assets/js/group_state.js?v=20250812";
  import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  const db = getFirestore();
  function gid(){ try { return GS.getCurrentGroupId?.() || 'default'; } catch(_ ){ return 'default'; } }
  const dateInput = document.getElementById('pickDate');

  // Firestore doc for shared selected date
  function commonUiRef(){ return doc(db, 'groups', gid(), 'ui', 'common'); }
  function computeDateKey(iso){ return (iso||'').replaceAll('-', ''); }

  let selectedDate = null;
  let unsub = null;

  async function saveSelectedDate(isoDate){
    if (!isoDate) return;
    selectedDate = isoDate;
    await setDoc(commonUiRef(), { selectedDate: isoDate, updatedAt: new Date() }, { merge:true });
    try { window.dateKey = computeDateKey(selectedDate); } catch(_){
      window.dateKey = computeDateKey(selectedDate);
    }
  }

  function subscribeSelectedDate(){
    if (unsub) { unsub(); unsub = null; }
    unsub = onSnapshot(commonUiRef(), (snap)=>{
      const data = snap.data() || {};
      const d = data.selectedDate;
      if (d && d !== selectedDate) {
        selectedDate = d;
        if (dateInput) {
          if (dateInput._flatpickr) {
            dateInput._flatpickr.setDate(selectedDate, true);
          } else {
            dateInput.value = selectedDate;
            dateInput.dispatchEvent(new Event('change'));
          }
        }
        try { window.dateKey = computeDateKey(selectedDate); } catch(_){
          window.dateKey = computeDateKey(selectedDate);
        }
      }
    });
  }

  document.addEventListener('DOMContentLoaded', () => {
    if (dateInput) {
      if (dateInput._flatpickr) {
        dateInput._flatpickr.config.onChange.push((dates, str)=>{ if (str) saveSelectedDate(str); });
      } else {
        dateInput.addEventListener('change', (e)=>{ const v = e.currentTarget.value; if (v) saveSelectedDate(v); });
      }
    }
    subscribeSelectedDate();
    // Initialize if empty
    setTimeout(()=>{
      if (!selectedDate) {
        const t = new Date();
        const yyyy = t.getFullYear();
        const mm = String(t.getMonth()+1).padStart(2,'0');
        const dd = String(t.getDate()).padStart(2,'0');
        saveSelectedDate(`${yyyy}-${mm}-${dd}`);
      }
    }, 150);
  });

function __updateRightCountFromState(){
  try{
    const rightCount = document.getElementById('rightCount');
    if (rightCount && window.state && Array.isArray(state.todays)) {
      rightCount.textContent = state.todays.length; // เพิ่มบรรทัดนี้
    }
  }catch(e){}
}
document.addEventListener('DOMContentLoaded', __updateRightCountFromState);
</script>


</body>


</html>